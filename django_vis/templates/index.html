{% extends 'base.html' %}
{% block head_inject %}
    <script type="text/javascript">
        $(document).ready(function () {
            $("#files-list").dataTable({
                "aoColumns": [{"sTitle": "Filename", "mData": "Filename"}],
                "sDom": "rt<'clear'>T",
                "oTableTools": {
                    "sRowSelect": "multi",
                    "aButtons": [ "select_all", "select_none" ],
                    "sSelectedClass": "selected",
                    "fnRowSelected": function (nodes) {
                        $(this.dom.table).trigger("selectionChanged");
                    },
                    "fnRowDeselected": function (nodes) {
                        $(this.dom.table).trigger("selectionChanged");
                    }
                },
                "oLanguage": {
                    "sEmptyTable": "No files added"
                }
            });
            $("#pieces-list").dataTable({
                "aoColumns": [
                    {"sTitle": "Filename", "mData": "filename"},
                    {"sTitle": "Title", "mData": "title"},
                    {"sTitle": "Part Names", "mData": "partNames"},
                    {"sTitle": "Offset", "mData": "offset"},
                    {"sTitle": "Part Combinations", "mData": "partCombinations"},
                    {"sTitle": "Repeat Identical", "mData": "repeatIdentical"}
                ],
                "sDom": "rt<'clear'>T",
                "oTableTools": {
                    "sRowSelect": "multi",
                    "aButtons": [ "select_all", "select_none" ],
                    "sSelectedClass": "selected",
                    "fnRowSelected": function (nodes) {
                        $(this.dom.table).trigger("selectionChanged");
                    },
                    "fnRowDeselected": function (nodes) {
                        $(this.dom.table).trigger("selectionChanged");
                    }
                },
                "oLanguage": {
                    "sEmptyTable": "No pieces imported"
                }
            });
            var wizard = new Wizard();
            var files_list = new ListOfFiles();
            pieces_list = new ListOfPieces();
            ko.applyBindings(wizard, document.getElementById('wizard'));
            ko.applyBindings(files_list, document.getElementById('import'));
            ko.applyBindings(pieces_list, document.getElementById('analysis-settings'));
            $("#wizard").on('change', function () {
                switch (selectedItem(this)) {
                    case 1:
                        $.ajax({
                            method: 'get',
                            url: '/api/import',
                            data: {
                                'filenames': _.map(files_list.items(),
                                        function (element) { return element.Filename; })
                            },
                            dataType: "json",
                            success: function (data, textStatus, jqXHR) {
                                data.forEach(function(item) {
                                    var piece = new Piece(item['Filename'], item['Title'], item['Part Names'], item['Offset'], item['Part Combinations'], item['Repeat Identical']);
                                    pieces_list.items.push(piece);
                                });
                            }
                        });
                        break;
                    case 2:
                        $.ajax({
                            method: 'get',
                            url: '/api/analyze',
                            data: {
                                'quality': $("input[name=qualityRadio]:checked").val(), 
                                'octaves': $("input[name=octaveRadio]:checked").val(),
                                'updated_pieces': ko.toJSON(pieces_list.items())
                            },
                            dataType: "json",
                            success: function(stuff) {
                                console.log(stuff);
                            }
                        });
                        break;
                }
            });
            
            Array.prototype.allValuesSame = function() {
                if (this.length > 1) {
                    for (var i=0; i<this.length; i++) {
                        if (this[i] !== this[0]) {
                            return false;
                        }
                    }
                }
                return true;
            }
            
            $("#settings-selected-button").click(function() {
                var form = $("#settings-selected-form");
                var message = $("#select-one-message");
                if (pieces_list.selectedItems().length == 0) {
                    // no pieces selected; show error message
                    message.show();
                    form.hide();
                } else if (pieces_list.selectedItems().length == 1) {
                    // one piece selected; show all settings
                    var piece = pieces_list.selectedItems()[0];
                    message.hide();
                    form.find("#title-div :input").val(piece.title());
                    form.find("#offset-div :input").val(piece.offset());
                    form.find("#part-names-div").children(":input").remove();
                    piece.partNames().forEach(function(partName) {
                        input = $('<input type="text" class="form-control">');
                        input.val(partName);
                        form.find("#part-names-div").append(input);
                    });
                    form.find("#part-comb-div :input").val(piece.partCombinations());
                    form.find("#repeat-ident-div :checkbox").prop("checked", piece.repeatIdentical());
                    form.show().children().show();
                } else {
                    // multiple pieces selected; show intersection of settings
                    var pieces = pieces_list.selectedItems();
                    var allNumbersOfParts = new Array();
                    var allOffsets = new Array();
                    var allPartCombinations = new Array();
                    var allRepeatIdents = new Array();
                    var hideElements = new Array();
                    var showElements = new Array();
                    pieces.forEach(function(piece) {
                        allNumbersOfParts.push(piece.partNames().length);
                        allOffsets.push(piece.offset()[0]);
                        allPartCombinations.push(piece.partCombinations());
                        allRepeatIdents.push(piece.repeatIdentical());
                    });
                    
                    // hide title when multiple pieces
                    hideElements.push(form.find("#title-div"));
                    
                    // if all selected have same number of parts, allow editing
                    // names of parts collectively
                    form.find("#part-names-div").children(":input").remove();
                    if (allNumbersOfParts.allValuesSame()) {
                        for (var i=0; i<allNumbersOfParts[0]; i++) {
                            input = $('<input type="text" class="form-control">');
                            input.val("Part " + i);
                            form.find("#part-names-div").append(input);
                        }
                        showElements.push(form.find("#part-names-div"));
                    } else {
                        hideElements.push(form.find("#part-names-div"));
                    }
                    
                    if (allOffsets.allValuesSame()) {
                        form.find("#offset-div :input").val(allOffsets[0]);
                        showElements.push(form.find("#offset-div"));
                    } else {
                        hideElements.push(form.find("#offset-div"));
                    }
                    
                    if (allPartCombinations.allValuesSame()) {
                        form.find("#part-comb-div :input").val(allPartCombinations[0]);
                        showElements.push(form.find("#part-comb-div"));
                    } else {
                        hideElements.push(form.find("#part-comb-div"));
                    }
                    
                    if (allRepeatIdents.allValuesSame()) {
                        form.find("#repeat-ident-div :input").val(allRepeatIdents[0]);
                        showElements.push(form.find("#repeat-ident-div"));
                    } else {
                        hideElements.push(form.find("#repeat-ident-div"));
                    }
                    
                    // hide and show appropriate form elements
                    showElements.forEach(function(element) {
                        element.show();
                    });
                    hideElements.forEach(function(element) {
                        element.hide();
                    });
                    message.hide();
                    form.show();
                }
                $("#settings-selected").modal("show");
            });
            
            $("#settings-selected-save-button").click(function() {
                var form = $("#settings-selected-form");
                pieces_list.selectedItems().forEach(function(item) {
                    if ($("#title-div").is(":visible")) {
                        item.title($("#title-div :input").val());
                    }
                    if ($("#offset-div").is(":visible")) {
                        item.offset($("#offset-div :input").val());
                    }
                    if ($("#part-comb-div").is(":visible")) {
                        item.partCombinations($("#part-comb-div :input").val());
                    }
                    if ($("#repeat-ident-div").is(":visible")) {
                        item.repeatIdentical($("#repeat-ident-div :checkbox").prop("checked"));
                    }
                });
                // shit how to set part names for multiple if user hasn't changed it fuck fuck fuck
                $("#settings-selected").modal("hide");
            });
        });
    </script>
    <style>
        img.step-img {
            max-height: 80%;
            padding-bottom: 5px;
            padding-right: 5px;
        }
        .fuelux .step-content tr.active {
            display: table-row;
        }
    </style>
{% endblock %}
{% block title %}
    vis X
{% endblock %}
{% block content %}
    <div class='container'>
        <div class='row'>
            <div class='span2'></div>
            <div class='span'>
                <div class="page-header">
                    <h1>vis X</h1>
                </div>
                <div id="wizard" class="wizard" data-bind="wizardStep: state">
                    <ul class="steps">
                        <li data-target="#import" class="active">
                            <span>
                                <img class="step-img"
                                     src="{{ STATIC_URL }}img/choose_files.png">
                            </span>
                            Import
                            <span class="chevron"></span>
                        </li>
                        <li data-target="#analysis-settings">
                            <span>
                                <img class="step-img"
                                     src="{{ STATIC_URL }}img/analyze.png">
                            </span>
                            Analysis Settings
                            <span class="chevron"></span>
                        </li>
                        <li data-target="#experiment-settings">
                            <span>
                                <img class="step-img"
                                     src="{{ STATIC_URL }}img/show_results.png">
                            </span>
                            Experiment Settings
                            <span class="chevron"></span></li>
                    </ul>
                    <div class="actions">
                        <button type="button"
                                class="btn btn-mini btn-next"
                                data-last="Visualize">
                            Next<i class="icon-arrow-right"></i></button>
                    </div>
                </div>
                <div class="step-content">
                    <div class="step-pane active" id="import">
                        <div class="well">
                            <div class="navbar">
                                <div class="navbar-inner">
                                    <a class="brand">
                                        Add files to the list so they will
                                        be imported.
                                    </a>
                                    <ul class="nav pull-right">
                                        <li>
                                            <a href="javascript:void(0);">
                                                <i class="icon-file"></i>
                                                Add File(s)
                                            </a>
                                        </li>
                                        <li>
                                            <a href="javascript:void(0);">
                                                <i class="icon-folder-open"></i>
                                                Add Folder(s)
                                            </a>
                                        </li>
                                        <li>
                                            <a id="remove-selected"
                                               href="javascript:void(0);"
                                               data-bind="click: removeSelected">
                                                <i class="icon-remove"></i>
                                                Remove Selected
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <table data-bind="tableData: items"
                                   class="table display datatable"
                                   id="files-list">
                                <tbody data-bind="selectedRows: selectedItems">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="step-pane" id="analysis-settings">
                        <div class="well">
                             <div class="navbar">
                                <div class="navbar-inner">
                                    <a class="brand">
                                        Select pieces and choose settings for analysis.
                                    </a>
                                    <ul class="nav pull-right">
                                        <li>
                                            <a data-toggle="modal"
                                               href="#settings-all">
                                                <i class="icon-ok"></i>
                                                Settings for all
                                            </a>
                                        </li>
                                        <li>
                                            <a data-toggle="modal"
                                               href="#"
                                               id="settings-selected-button">
                                                <i class="icon-ok"></i>
                                                Settings for selected
                                            </a>
                                        </li>
                                        <li>
                                            <a id="remove-selected"
                                               href="javascript:void(0);">
                                                <i class="icon-remove"></i>
                                                Clear all settings
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="modal fade" 
                                 id="settings-all"
                                 tabindex="-1"
                                 role="dialog"
                                 aria-labelledby="label"
                                 aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content"> 
                                        <div class="modal-header">
                                            <button type="button"
                                                    class="close"
                                                    data-dismiss="modal"
                                                    aria-hidden="true">
                                                &times;
                                            </button>
                                            <h4 class="modal-title">
                                                Settings for all pieces
                                            </h4>
                                        </div>
                                        <div class="modal-body">
                                            <h5> Interval Quality </h5>
                                            <div class="radio">
                                                <label>
                                                    <input type="radio"
                                                           name="qualityRadio"
                                                           value="display"
                                                           checked />
                                                    Display
                                                </label>
                                            </div>
                                            <div class="radio">
                                                <label>
                                                    <input type="radio"
                                                           name="qualityRadio"
                                                           value="ignore" />
                                                    Ignore
                                                </label>
                                            </div>
                                            <h5> Octaves </h5>
                                            <div class="radio">
                                                <label>
                                                    <input type="radio"
                                                           name="octaveRadio"
                                                           value="compound"
                                                           checked />
                                                    Compound
                                                </label>
                                            </div>
                                            <div class="radio">
                                                <label>
                                                    <input type="radio"
                                                           name="octaveRadio"
                                                           value="simple" />
                                                    Simple
                                                </label>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button"
                                                    class="btn bn-default"
                                                    data-dismiss="modal">
                                                Done
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal fade" 
                                 id="settings-selected"
                                 tabindex="-1"
                                 role="dialog"
                                 aria-labelledby="label"
                                 aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content"> 
                                        <div class="modal-header">
                                            <button type="button"
                                                    class="close"
                                                    data-dismiss="modal"
                                                    aria-hidden="true">
                                                &times;
                                            </button>
                                            <h4 class="modal-title">
                                                Settings for selected piece(s)
                                            </h4>
                                        </div>
                                        <div class="modal-body">
                                            <h5 id="select-one-message">Please select at least one piece</h5>
                                            <form role="form"
                                                  id="settings-selected-form">
                                                <div class="form-group"
                                                     id="title-div">
                                                    <label for="pieceTitle">Piece title</label>
                                                    <input type="text" class="form-control" />
                                                </div>
                                                <div class="form-group"
                                                     id="part-names-div">
                                                    <label for="partNames">Part Names</label>
                                                </div>
                                                <div class="form-group"
                                                     id="offset-div">
                                                    <label for="offsetInterval">Offset interval</label>
                                                    <input type="text" class="form-control" placeholder="(optional)" />
                                                </div>
                                                <div class="form-group"
                                                     id="part-comb-div">
                                                    <label for="partCombinations">Part Combinations</label>
                                                    <input type="text" class="form-control" placeholder="(none selected)" />
                                                </div>
                                                <div class="form-group"
                                                     id="repeat-ident-div">
                                                    <label>
                                                        <input type="checkbox"> Repeat consecutive identical events
                                                    </label>
                                                </div>
                                            </form>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button"
                                                    class="btn bn-default"
                                                    data-dismiss="modal">
                                                Cancel
                                            </button>
                                            <button type="button"
                                                    class="btn bn-default"
                                                    id="settings-selected-save-button">
                                                Save
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <table data-bind="tableData: items"
                                   class="table display datatable"
                                   id="pieces-list">
                                <tbody data-bind="selectedRows: selectedItems">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="step-pane" id="experiment-settings">This is step 3</div>
                </div>
            </div>
            <div class='span2'></div>
        </div>
    </div>
{% endblock %}
