{% extends 'base.html' %}
{% block head_inject %}
    <script type="text/javascript">
        $(document).ready(function () {
            $("#files-list").dataTable({
                "aoColumns": [{"sTitle": "Filename", "mData": "Filename"}],
                "sDom": "rt<'clear'>T",
                "oTableTools": {
                    "sRowSelect": "multi",
                    "aButtons": [ "select_all", "select_none" ],
                    "sSelectedClass": "selected",
                    "fnRowSelected": function (nodes) {
                        $(this.dom.table).trigger("selectionChanged");
                    },
                    "fnRowDeselected": function (nodes) {
                        $(this.dom.table).trigger("selectionChanged");
                    }
                },
                "oLanguage": {
                    "sEmptyTable": "No files added"
                }
            });
            $("#pieces-list").dataTable({
                "aoColumns": [
                    {"sTitle": "Path", "mData": "path"},
                    {"sTitle": "Title", "mData": "title"},
                    {"sTitle": "Part Names", "mData": "partNames"},
                    {"sTitle": "Offset", "mData": "offset"},
                    {"sTitle": "Part Combinations", "mData": "partCombinations"},
                    {"sTitle": "Repeat Identical", "mData": "repeatIdentical"}
                ],
                "sDom": "rt<'clear'>T",
                "oTableTools": {
                    "sRowSelect": "multi",
                    "aButtons": [ "select_all", "select_none" ],
                    "sSelectedClass": "selected",
                    "fnRowSelected": function (nodes) {
                        $(this.dom.table).trigger("selectionChanged");
                    },
                    "fnRowDeselected": function (nodes) {
                        $(this.dom.table).trigger("selectionChanged");
                    }
                },
                "oLanguage": {
                    "sEmptyTable": "No pieces imported"
                }
            });
            var wizard = new Wizard();
            var files_list = new ListOfFiles();
            pieces_list = new ListOfPieces();
            ko.applyBindings(wizard, document.getElementById('wizard'));
            ko.applyBindings(files_list, document.getElementById('import'));
            ko.applyBindings(pieces_list, document.getElementById('analyze'));
            $("#wizard").on('change', function () {
                switch (selectedItem(this)) {
                    case 1:
                        $.ajax({
                            method: 'get',
                            url: '/api/import',
                            data: {
                                'filenames': _.map(files_list.items(),
                                        function (element) { return element.Filename; })
                            },
                            dataType: "json",
                            success: function (data, textStatus, jqXHR) {
                                data.forEach(function(item) {
                                    var piece = new Piece(item['Path'], item['Title'], item['Part Names'], item['Offset'], item['Part Combinations'], item['Repeat Identical']);
                                    pieces_list.items.push(piece);
                                });
                            }
                        });
                        break;
                    case 2:
                        $.ajax({
                            method: 'get',
                            url: '/api/analyze',
                            data: {
                                'filenames': _.map(files_list.items(),
                                        function (element) { return element.Filename; })
                            },
                            dataType: "json",
                        });
                        break;
                }
            });
            $("#settings-selected-button").click( function() {
                var form = $("#settings-selected-form");
                var message = $("#select-one-message");
                if (pieces_list.selectedItems().length == 0) {
                    message.show();
                    form.hide();
                } else if (pieces_list.selectedItems().length == 1) {
                    var piece = pieces_list.selectedItems()[0];
                    message.hide();
                    form.find("#title-div :input").val(piece['title']);
                    form.find("#offset-div :input").val(piece['offset'][0]);
                    form.find("#part-names-div").children(":input").remove();
                    piece.partNames.forEach(function(partName) {
                        input = $('<input type="text" class="form-control">');
                        input.val(partName);
                        form.find("#part-names-div").append(input);
                    });
                    form.find("#part-comb-div :input").val(piece['partCombinations']);
                    form.find("#repeat-ident-div :checkbox").val(piece['repeatIdentical']);
                    form.show();
                    console.log(pieces_list.selectedItems());
                    // display all items
                } else {
                    // display intersections of settings
                    message.hide();
                    console.log("lol");
                }
                $("#settings-selected").modal("show");
            });
        });
    </script>
    <style>
        img.step-img {
            max-height: 80%;
            padding-bottom: 5px;
            padding-right: 5px;
        }
        .fuelux .step-content tr.active {
            display: table-row;
        }
    </style>
{% endblock %}
{% block title %}
    vis X
{% endblock %}
{% block content %}
    <div class='container'>
        <div class='row'>
            <div class='span2'></div>
            <div class='span'>
                <div class="page-header">
                    <h1>vis X</h1>
                </div>
                <div id="wizard" class="wizard" data-bind="wizardStep: state">
                    <ul class="steps">
                        <li data-target="#import" class="active">
                            <span>
                                <img class="step-img"
                                     src="{{ STATIC_URL }}img/choose_files.png">
                            </span>
                            Import
                            <span class="chevron"></span>
                        </li>
                        <li data-target="#analyze">
                            <span>
                                <img class="step-img"
                                     src="{{ STATIC_URL }}img/analyze.png">
                            </span>
                            Analyze
                            <span class="chevron"></span>
                        </li>
                        <li data-target="#experiment">
                            <span>
                                <img class="step-img"
                                     src="{{ STATIC_URL }}img/show_results.png">
                            </span>
                            Experiment
                            <span class="chevron"></span></li>
                    </ul>
                    <div class="actions">
                        <button type="button"
                                class="btn btn-mini btn-next"
                                data-last="Visualize">
                            Next<i class="icon-arrow-right"></i></button>
                    </div>
                </div>
                <div class="step-content">
                    <div class="step-pane active" id="import">
                        <div class="well">
                            <div class="navbar">
                                <div class="navbar-inner">
                                    <a class="brand">
                                        Add files to the list so they will
                                        be imported.
                                    </a>
                                    <ul class="nav pull-right">
                                        <li>
                                            <a href="javascript:void(0);">
                                                <i class="icon-file"></i>
                                                Add File(s)
                                            </a>
                                        </li>
                                        <li>
                                            <a href="javascript:void(0);">
                                                <i class="icon-folder-open"></i>
                                                Add Folder(s)
                                            </a>
                                        </li>
                                        <li>
                                            <a id="remove-selected"
                                               href="javascript:void(0);"
                                               data-bind="click: removeSelected">
                                                <i class="icon-remove"></i>
                                                Remove Selected
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <table data-bind="tableData: items"
                                   class="table display datatable"
                                   id="files-list">
                                <tbody data-bind="selectedRows: selectedItems">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="step-pane" id="analyze">
                        <div class="well">
                             <div class="navbar">
                                <div class="navbar-inner">
                                    <a class="brand">
                                        Select pieces and choose settings for analysis.
                                    </a>
                                    <ul class="nav pull-right">
                                        <li>
                                            <a data-toggle="modal"
                                               href="#settings-all">
                                                <i class="icon-ok"></i>
                                                Settings for all
                                            </a>
                                        </li>
                                        <li>
                                            <a data-toggle="modal"
                                               href="#"
                                               id="settings-selected-button">
                                                <i class="icon-ok"></i>
                                                Settings for selected
                                            </a>
                                        </li>
                                        <li>
                                            <a id="remove-selected"
                                               href="javascript:void(0);">
                                                <i class="icon-remove"></i>
                                                Clear all settings
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="modal fade" 
                                 id="settings-all"
                                 tabindex="-1"
                                 role="dialog"
                                 aria-labelledby="label"
                                 aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content"> 
                                        <div class="modal-header">
                                            <button type="button"
                                                    class="close"
                                                    data-dismiss="modal"
                                                    aria-hidden="true">
                                                &times;
                                            </button>
                                            <h4 class="modal-title">
                                                Settings for all pieces
                                            </h4>
                                        </div>
                                        <div class="modal-body">
                                            <h5> Interval Quality </h5>
                                            <div class="radio">
                                                <label>
                                                    <input type="radio"
                                                           name="qualityRadio"
                                                           id="qualityDisplay"
                                                           value="display"
                                                           checked />
                                                    Display
                                                </label>
                                            </div>
                                            <div class="radio">
                                                <label>
                                                    <input type="radio"
                                                           name="qualityRadio"
                                                           id="qualityIgnore"
                                                           value="ignore" />
                                                    Ignore
                                                </label>
                                            </div>
                                            <h5> Octaves </h5>
                                            <div class="radio">
                                                <label>
                                                    <input type="radio"
                                                           name="octaveRadio"
                                                           id="octaveCompound"
                                                           value="compound"
                                                           checked />
                                                    Compound
                                                </label>
                                            </div>
                                            <div class="radio">
                                                <label>
                                                    <input type="radio"
                                                           name="octaveRadio"
                                                           id="octaveSimple"
                                                           value="simple" />
                                                    Simple
                                                </label>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button"
                                                    class="btn bn-default"
                                                    data-dismiss="modal">
                                                Cancel
                                            </button>
                                            <button type="button"
                                                    class="btn bn-default">
                                                Save 
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal fade" 
                                 id="settings-selected"
                                 tabindex="-1"
                                 role="dialog"
                                 aria-labelledby="label"
                                 aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content"> 
                                        <div class="modal-header">
                                            <button type="button"
                                                    class="close"
                                                    data-dismiss="modal"
                                                    aria-hidden="true">
                                                &times;
                                            </button>
                                            <h4 class="modal-title">
                                                Settings for selected piece(s)
                                            </h4>
                                        </div>
                                        <div class="modal-body">
                                            <h5 id="select-one-message">Please select at least one piece</h5>
                                            <form role="form"
                                                  id="settings-selected-form">
                                                <div class="form-group"
                                                     id="title-div">
                                                    <label for="pieceTitle">Piece title</label>
                                                    <input type="text" class="form-control" />
                                                </div>
                                                <div class="form-group"
                                                     id="part-names-div">
                                                    <label for="partNames">Part Names</label>
                                                </div>
                                                <div class="form-group"
                                                     id="offset-div">
                                                    <label for="offsetInterval">Offset interval</label>
                                                    <input type="text" class="form-control" placeholder="(optional)" />
                                                </div>
                                                <div class="form-group"
                                                     id="part-comb-div">
                                                    <label for="partCombinations">Part Combinations</label>
                                                    <input type="text" class="form-control" placeholder="(none selected)" />
                                                </div>
                                                <div class="form-group"
                                                     id="repeat-ident-div">
                                                    <label>
                                                        <input type="checkbox"> Repeat consecutive identical events
                                                    </label>
                                                </div>
                                            </form>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button"
                                                    class="btn bn-default"
                                                    data-dismiss="modal">
                                                Cancel
                                            </button>
                                            <button type="button"
                                                    class="btn bn-default">
                                                Save
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <table data-bind="tableData: items"
                                   class="table display datatable"
                                   id="pieces-list">
                                <tbody data-bind="selectedRows: selectedItems">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="step-pane" id="experiment">This is step 3</div>
                </div>
            </div>
            <div class='span2'></div>
        </div>
    </div>
{% endblock %}
